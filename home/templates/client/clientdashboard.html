{% extends "client_home_base.html" %}

{% block title %}Data Connections | {{ super() }}{% endblock %}

{% block content %}
<div class="mb-6">
  <h1 class="text-2xl font-bold mb-2">Overiew</h1>
  <p class="text-gray-600">Monitor the health of your data sources</p>
</div>

<!-- Filters Section -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
    <!-- Connection Filter -->
    <div>
      <label for="connectionFilter" class="block text-sm font-medium text-gray-700 mb-1">Connection</label>
      48
    </div>

    <!-- Data Group Filter -->
    <div>
      <label for="dataGroupFilter" class="block text-sm font-medium text-gray-700 mb-1">Data Group</label>
      55
    </div>

    <!-- Schema Filter -->
    <div>
      <label for="schemaFilter" class="block text-sm font-medium text-gray-700 mb-1">Schema</label>
     89
    </div>

    <!-- Table Filter -->
    <div>
      <label for="tableFilter" class="block text-sm font-medium text-gray-700 mb-1">Table</label>
     70
    </div>

    <!-- Time Filter -->
    <div>
      <label for="timeFilter" class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
      99
    </div>
  </div>

  <div class="flex justify-end mt-4 space-x-3">
    
    <button id="applyFilters" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
      <i class="fas fa-plus mr-2"></i>Add New Connection
    </button>
  </div>
</div>

<!-- Data Quality Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
  <table class="min-w-full divide-y divide-gray-200" id="dataQualityTable">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Connection</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Schemas</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tables</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data Quality</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Checked</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">View More</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200" id="dataQualityTableBody">
      {% for conn in connections %}
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <i class="fas fa-{{ conn.icon }} mr-3 text-{{ conn.color }}-500"></i>
            <div>
              <div class="font-medium">{{ conn.name }}</div>
              <div class="text-sm text-gray-500">{{ conn.type }}</div>
              
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">{{ conn.schemas }}</td>
        <td class="px-6 py-4 whitespace-nowrap">{{ conn.tables }}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="quality-bar bg-gray-200 rounded-full overflow-hidden h-4" role="progressbar" aria-valuenow="{{ conn.quality.good|safe_percent }}" aria-valuemin="0" aria-valuemax="100">
            <div class="flex h-full">
              <div style="width: {{ conn.quality.good|safe_percent }}%" class="bg-green-500" aria-label="Good: {{ conn.quality.good|safe_percent }}%"></div>
              <div style="width: {{ conn.quality.warning|safe_percent }}%" class="bg-yellow-500" aria-label="Warning: {{ conn.quality.warning|safe_percent }}%"></div>
              <div style="width: {{ conn.quality.bad|safe_percent }}%" class="bg-red-500" aria-label="Bad: {{ conn.quality.bad|safe_percent }}%"></div>
            </div>
          </div>
          <div class="text-xs mt-1 text-gray-600">
            {{ conn.quality.good|safe_percent }}% Good, {{ conn.quality.warning|safe_percent }}% Warning, {{ conn.quality.bad|safe_percent }}% Bad
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          {{ conn.last_checked|datetimeformat }}
        </td>
        <td>
    <div class="flex items-center">
        <form action="{{ url_for('home.client_tables') }}" method="POST" class="hidden" id="form-{{ conn.id }}">
            <input type="hidden" name="conn_id" value="{{ conn.id }}">
        </form>
        <button type="submit" form="form-{{ conn.id }}" class="focus:outline-none">
            <i class="fas fa-eye mr-3 text-{{ conn.color }}-500"></i>
        </button>
        <div>
</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Status Legend -->
<div class="mt-4 flex flex-wrap gap-4 text-sm">
  <div class="flex items-center">
    <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
    <span>Good (â‰¥80%)</span>
  </div>
  <div class="flex items-center">
    <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
    <span>Warning (60-79%)</span>
  </div>
  <div class="flex items-center">
    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
    <span>Critical (<60%)</span>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- eslint-disable -->
<script>
const initialData = {
  connections: {{ connections|tojson|safe }},
  data_groups: {{ data_groups|tojson|safe }},
  schemas: {{ schemas|tojson|safe }},
  tables: {{ tables|tojson|safe }}
};

document.addEventListener('DOMContentLoaded', function() {
  const connectionFilter = document.getElementById('connectionFilter');
  const dataGroupFilter = document.getElementById('dataGroupFilter');
  const schemaFilter = document.getElementById('schemaFilter');
  const tableFilter = document.getElementById('tableFilter');
  const timeFilter = document.getElementById('timeFilter');
  const resetFilters = document.getElementById('resetFilters');
  const applyFilters = document.getElementById('applyFilters');
  const tableBody = document.getElementById('dataQualityTableBody');

  // Function to update schema filter
  function updateSchemaFilter(data) {
    const selectedConnection = connectionFilter.value;
    const selectedDataGroup = dataGroupFilter.value;
    schemaFilter.innerHTML = '<option value="all">All Schemas</option>';

    data.schemas.forEach(schema => {
      const dataGroup = data.data_groups.find(g => g.id === schema.data_group_id);
      if (
        (selectedDataGroup === 'all' || schema.data_group_id === selectedDataGroup) &&
        (selectedConnection === 'all' || schema.connection_id === selectedConnection)
      ) {
        const option = document.createElement('option');
        option.value = schema.id;
        option.setAttribute('data-data-group-id', schema.data_group_id);
        option.textContent = `${schema.name} (${dataGroup ? dataGroup.name : 'Unknown'}, ${data.connections.find(c => c.id === schema.connection_id)?.name || 'Unknown'})`;
        schemaFilter.appendChild(option);
      }
    });

    updateTableFilter(data);
  }

  // Function to update table filter
  function updateTableFilter(data) {
    const selectedConnection = connectionFilter.value;
    const selectedDataGroup = dataGroupFilter.value;
    const selectedSchema = schemaFilter.value;
    tableFilter.innerHTML = '<option value="all">All Tables</option>';

    data.tables.forEach(table => {
      const schema = data.schemas.find(s => s.id === table.schema_id);
      const dataGroup = data.data_groups.find(g => g.id === table.data_group_id);
      if (
        (selectedSchema === 'all' || table.schema_id === selectedSchema) &&
        (selectedDataGroup === 'all' || table.data_group_id === selectedDataGroup) &&
        (selectedConnection === 'all' || table.connection_id === selectedConnection)
      ) {
        const option = document.createElement('option');
        option.value = table.id;
        option.setAttribute('data-schema-id', table.schema_id);
        option.textContent = `${table.name} (${schema ? schema.name : 'Unknown'}, ${dataGroup ? dataGroup.name : 'Unknown'})`;
        tableFilter.appendChild(option);
      }
    });
  }

  // Function to update table body
  function updateTableBody(connections) {
    tableBody.innerHTML = '';
    if (connections.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No connections match the selected filters</td></tr>';
      return;
    }
    connections.forEach(conn => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <i class="fas fa-${conn.icon} mr-3 text-${conn.color}-500"></i>
            <div>
              <div class="font-medium">${conn.name}</div>
              <div class="text-sm text-gray-500">${conn.type}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">${conn.schemas}</td>
        <td class="px-6 py-4 whitespace-nowrap">${conn.tables}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="quality-bar bg-gray-200 rounded-full overflow-hidden h-4" role="progressbar" aria-valuenow="${conn.quality.good}" aria-valuemin="0" aria-valuemax="100">
            <div class="flex h-full">
              <div style="width: ${Math.max(0, Math.min(conn.quality.good, 100))}%" class="bg-green-500" aria-label="Good: ${conn.quality.good}%"></div>
              <div style="width: ${Math.max(0, Math.min(conn.quality.warning, 100))}%" class="bg-yellow-500" aria-label="Warning: ${conn.quality.warning}%"></div>
              <div style="width: ${Math.max(0, Math.min(conn.quality.bad, 100))}%" class="bg-red-500" aria-label="Bad: ${conn.quality.bad}%"></div>
            </div>
          </div>
          <div class="text-xs mt-1 text-gray-600">
            ${conn.quality.good}% Good, ${conn.quality.warning}% Warning, ${conn.quality.bad}% Bad
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          ${conn.last_checked}
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  // Event listeners for filter changes
  connectionFilter.addEventListener('change', fetchFilters);
  dataGroupFilter.addEventListener('change', fetchFilters);
  schemaFilter.addEventListener('change', fetchFilters);
  timeFilter.addEventListener('change', fetchFilters);

  // Apply filters
  applyFilters.addEventListener('click', fetchFilters);

  // Reset filters
  resetFilters.addEventListener('click', function() {
    connectionFilter.value = 'all';
    dataGroupFilter.value = 'all';
    schemaFilter.value = 'all';
    tableFilter.value = 'all';
    timeFilter.value = 'current_month';
    fetchFilters();
  });

  // Fetch filtered data from server
  function fetchFilters() {
    const filters = {
      connection: connectionFilter.value,
      group: dataGroupFilter.value,
      schema: schemaFilter.value,
      table: tableFilter.value,
      time: timeFilter.value
    };

    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td></tr>';

    fetch('/client/filter_data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(filters)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        updateSchemaFilter(data);
        updateTableFilter(data);
        updateTableBody(data.connections);
      })
      .catch(error => {
        console.error('Error fetching filtered data:', error);
        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Error loading data: ' + error.message + '</td></tr>';
      });
  }
});
</script>
<!-- eslint-enable -->
{% endblock %}