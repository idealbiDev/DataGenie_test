{% extends "client_home_base.html" %}

{% block title %}New Connection - Step 1{% endblock %}

{% block content %}
<style>
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 10px; /* Table body font size */
    }
    
    .data-table th, .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .data-table th {
      background-color: #c0c0c0; /* Silver gray */
      font-size: 10px; /* Header font size */
    }
    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
   
  
  .data-table caption {
    caption-side: top;
    background-color: #001f3f;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 12px;
    border: 1px solid #001f3f;
    border-bottom: none;
    position: relative;
  }
  .caption-content {
    display: inline-block;
    margin: 0 auto;
  }
  .dq-link {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    font-size: 14px;
    text-decoration: none;
    transition: color 0.3s;
  }
  .dq-link:hover {
    color: #4CAF50; /* Green color on hover */
  }
  </style>
</head>
<body>
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-database me-2"></i>Data Quality Monitor - Column Descriptions</h3>
        </div>
        <div class="card-body">
            <div class="mb-4">
            <button
                type="button"
                onclick="exportTablesToExcel()"
                class="btn btn-primary"
                aria-label="Export all tables to Excel"
            >
                <i class="fas fa-file-excel me-1"></i> Export to Excel
            </button> <button
                type="button"
                onclick="exportTablesToExcel()"
                class="btn btn-secondary"
                aria-label="Export all tables to Excel"
            >
                <i class="fas fa-file-database me-2"></i> Write to DB
            </button>
        </div>
            {% set dict_tables = doservice_list.dict_tables %}
            {% set db_type = doservice_list.db_type %}
            {% set conn_str = doservice_list.conn_str %}
            
              {% for t, columns in descriptions.items() %}
                <table class="data-table">
                    <caption>
                        <span class="caption-content">{{ t }}</span>
                        <form method="POST" action="{{ url_for('data_dictionary.dataquality') }}" class="dq-form">
                          <input type="hidden" name="table_name" value="{{ dict_tables }}">
                          <input type="hidden" name="db_type" value="{{db_type}}">
                          <input type="hidden" name="conn_str" value="{{conn_str}}">
                          <input type="hidden" name="db_schema_name" value="{{db_schema_name}}">
                     
                          <!-- Add other hidden fields as needed -->
                          <button type="submit" class="dq-submit" title="View Data Quality Metrics">
                            <i class="fas fa-chart-line"></i> <!-- Suggested icon -->
                          </button>
                        </form>
                      </caption>
                  <thead>
                    <tr>
                      <th>Column Name</th>
                      <th>Business Purpose</th>
                      <th>Data Quality Rules</th>
                      <th>Example Usage</th>
                      <th>Issues</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if columns %}
                      {% for column_info in columns %}
                        <tr>
                          {% set column_desc_dict = column_info.column_desc[0] %}
                          <td>{{ column_info.column_name }}</td>
                          <td>{{ column_desc_dict.business_purpose }}</td>
                          <td>{{ column_desc_dict.data_quality_rules }}</td>
                          <td>{{ column_desc_dict.example_usage }}</td>
                          <td>{{ column_desc_dict.issues }}</td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="5">No columns described</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              {% endfor %}

   

   
</div>
</div>


<!-- Include SheetJS CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- JavaScript for Exporting Tables -->
<script>
function exportTablesToExcel() {
    // Create a new workbook
    const wb = XLSX.utils.book_new();

    // Select all tables with class 'data-table'
    const tables = document.querySelectorAll('table.data-table');
    
    tables.forEach((table, index) => {
        // Get sheet name from caption-content or default to 'Sheet' + index
        const captionElement = table.querySelector('.caption-content');
        const sheetName = captionElement ? captionElement.textContent.trim() : `Sheet${index + 1}`;
        
        // Create a temporary table to exclude the form in the caption
        const tempTable = document.createElement('table');
        tempTable.innerHTML = `
            <thead>${table.querySelector('thead').innerHTML}</thead>
            <tbody>${table.querySelector('tbody').innerHTML}</tbody>
        `;
        
        // Convert temporary table to worksheet
        const ws = XLSX.utils.table_to_sheet(tempTable, { raw: true });
        
        // Append worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, sheetName.slice(0, 31)); // Excel sheet names max 31 chars
    });

    // Generate and download the Excel file
    XLSX.write(wb, 'data_quality_tables.xlsx');
}
</script>
{% endblock %}
